rules_version = '2';
service cloud.firestore {
	match /databases/{database}/documents {
		match /users/{userId} {
			// Only if own doc or the user is from the same room
			allow read: if authUidMatchesNoVerification(userId) || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.domain == resource.data.domain;
		}
		match /user_personal_data/{userId} {
			allow get, update: if authUidMatchesResourceId();
			allow create: if authUidMatches(userId);
		}
		match /reading/{userId} {
			allow read, write: if authUidMatches(userId);
		}
		match /rooms/{domain} {
			allow get: if isMyDomain(domain);

			match /members/{userId} {
				allow read: if isMyDomain(domain);
				allow update: if isMyDomain(domain) && authUidMatches(userId);
			}
			match /reports/{uid} {
				allow create: if isMyDomain(domain);
			}
		}
		match /chats/{domain} {
			allow get, update: if isMyDomain(domain);
		}
		match /{path=**}/reports/{uid} {
        	allow read, write: if isVerified() && isAdmin();
        }


		function isVerified() {
			return request.auth.token.email_verified == true || exists(/databases/$(database)/documents/users/$(request.auth.uid));
		}
		function authUidMatches(uid) {
			return request.auth != null && request.auth.uid == uid && isVerified();
		}
		function authUidMatchesNoVerification(uid) {
			return request.auth != null && request.auth.uid == uid;
		}
		function authUidMatchesResourceId() {
		  	return resource != null && authUidMatches(resource.id) && isVerified();
		}
		function isMyDomain(domain) {
			return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.domain == domain && isVerified();
		}
		function isAdmin() {
			return request.auth.token.email == 'simon@job-tunnel.com' || request.auth.token.email == 'simon@decompresso.fr' || request.auth.token.email == 'annabelle@job-tunnel.com' || request.auth.token.email == 'annabelle@decompresso.fr' ;
		}
	}
}
